services:
  # Backend Django
  - type: web
    name: residuos-backend
    plan: free
    dockerfile: ./Dockerfile
    dockerContext: ./
    startCommand: >
      cd backend &&
      python manage.py migrate --no-input &&
      python manage.py collectstatic --noinput &&
      gunicorn config.wsgi:application --bind 0.0.0.0:10000 --workers 2 --timeout 120
    healthCheckPath: /health/
    healthCheckStartupTimeout: 300
    envVars:
      - key: DEBUG
        value: "False"
      - key: ENVIRONMENT
        value: "production"
      - key: ALLOWED_HOSTS
        scope: build,runtime
        sync: false
      - key: SECRET_KEY
        scope: build,runtime
        sync: false
      - key: DATABASE_URL
        scope: build,runtime
        sync: false
      - key: REDIS_URL
        scope: build,runtime
        sync: false
      - key: RABBITMQ_URL
        scope: build,runtime
        sync: false
      - key: SUPABASE_URL
        scope: build,runtime
        sync: false
      - key: SUPABASE_KEY
        scope: build,runtime
        sync: false
    disk:
      name: django_staticfiles
      path: /var/data/staticfiles
      sizeGB: 1

  # Frontend React
  - type: static_site
    name: residuos-frontend
    runtime: node
    plan: free
    buildCommand: >
      cd frontend &&
      npm install &&
      npm run build
    staticPublishPath: frontend/build
    envVars:
      - key: REACT_APP_API_URL
        value: "https://residuos-backend.onrender.com/api"
      - key: REACT_APP_WEBSOCKET_URL
        value: "wss://residuos-backend.onrender.com/ws"
    routes:
      - path: "/"
        destination: "/index.html"

  # Base de Datos PostgreSQL (Opcional - usar Supabase o Render DB)
  # Descomenta si deseas crear la BD en Render (requiere plan pago)
  # - type: pserv
  #   name: residuos-db
  #   plan: starter
  #   postgresVersion: 15
  #   databaseName: residuos_latacunga
  #   username: postgres
  #   ipAllowList: []
